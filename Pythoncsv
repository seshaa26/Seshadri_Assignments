import os
import shutil
import re
import csv

# --- Configuration ---
source_folder = './all_files'       
destination_folder = './matched_files'
keywords_file = 'ids.csv'           # Your CSV file
log_file = 'match_log.csv' 

def copy_and_log_files():
    # 1. Load keywords using built-in CSV module (No Pandas needed!)
    keywords = []
    try:
        with open(keywords_file, 'r') as f:
            reader = csv.reader(f)
            next(reader) # Skip the header row
            for row in reader:
                if row:
                    keywords.append(row[0].strip())
        print(f"Loaded {len(keywords)} IDs.")
    except Exception as e:
        print(f"Error loading CSV: {e}")
        return

    # 2. Build the "Prefix-Friendly" Pattern
    # This looks for: Any non-space chars + Your 16-digit ID + Any non-space chars
    # Example: It will catch "INV-1234567890123456"
    pattern = re.compile(r'\S*(' + '|'.join(map(re.escape, keywords)) + r')\S*')

    if not os.path.exists(destination_folder):
        os.makedirs(destination_folder)

    # 3. Scan and Copy
    with open(log_file, 'w', newline='', encoding='utf-8') as log_csv:
        log_writer = csv.writer(log_csv)
        log_writer.writerow(['Filename', 'Full_Match_Found'])

        all_files = [f for f in os.listdir(source_folder) if f.endswith(".txt")]
        
        for filename in all_files:
            file_path = os.path.join(source_folder, filename)
            try:
                with open(file_path, 'r', encoding='latin-1') as f:
                    content = f.read()
                    matches = pattern.findall(content)
                    
                    if matches:
                        shutil.copy(file_path, destination_folder)
                        for m in set(matches):
                            log_writer.writerow([filename, m])
                        print(f"Match in {filename}: {matches}")
            except Exception as e:
                print(f"Error reading {filename}: {e}")

    print(f"\nTask complete. Check {log_file} for details.")

if __name__ == "__main__":
    copy_and_log_files()
