import os
import shutil
import re
import pandas as pd
import csv

# --- Configuration ---
source_folder = './all_files'       
destination_folder = './matched_files'
keywords_file = 'ids.csv'           
column_name = 'ID_Number'           
log_file = 'match_log.csv' 

def copy_and_log_files():
    # 1. Load keywords using Pandas
    try:
        # Keep as string to preserve the full 16 digits
        df = pd.read_csv(keywords_file, dtype={column_name: str})
        keywords = df[column_name].str.strip().tolist()
        print(f"Searching for {len(keywords)} IDs...")
    except Exception as e:
        print(f"Error loading CSV: {e}")
        return

    # 2. Updated Regex Pattern
    # \S* matches any non-whitespace characters (prefixes like 'INV-' or 'TXN')
    # we use map(re.escape) to ensure the 16 digits are treated as literal text
    pattern = re.compile(r'\S*(?:' + '|'.join(map(re.escape, keywords)) + r')\S*')

    if not os.path.exists(destination_folder):
        os.makedirs(destination_folder)

    # 3. Process and Log
    with open(log_file, 'w', newline='', encoding='utf-8') as log_csv:
        log_writer = csv.writer(log_csv)
        log_writer.writerow(['Filename', 'Full_String_Found'])

        all_files = [f for f in os.listdir(source_folder) if f.endswith(".txt")]
        
        for filename in all_files:
            file_path = os.path.join(source_folder, filename)
            try:
                with open(file_path, 'r', encoding='latin-1') as f:
                    content = f.read()
                    # findall returns the full string including prefixes
                    matches = pattern.findall(content)
                    
                    if matches:
                        shutil.copy(file_path, destination_folder)
                        # set() ensures we don't log the exact same string twice for one file
                        for m in set(matches):
                            log_writer.writerow([filename, m])
            except Exception as e:
                print(f"Error processing {filename}: {e}")

    print(f"Process complete. Files copied to {destination_folder}")

if __name__ == "__main__":
    copy_and_log_files()
